# [20210805 JWT]

### 간단 정의:
권한 인가(Authorization)를 위해 사용하는 토큰

### 세션:  
로그인에 성공하면(인증되면) 서버는 XX랜드 티켓을 발급해서 반쪽은 사용자의 브라우저,    
다른 반쪽은 서버에 둔다(메모리 혹은 하드디스크에 넣어둔다. 데이터베이스에 둘 때도 있다)(stateful).   
사용자의 브라우저는 반 쪽표를 쿠키로 세션id를 저장한다. 그 이후, 요청을 보낼 떄마다 이 표를 실어보낸다.    
서버는 세션id를 전달 받는 다면,    
메모리, 하드디스크, 데이터베이스 던 저장해놓은 곳에서 일치하는 정보가 있는 지 찾아본다.  
서버에 로그인 상태가 지속되는 것이 세션이라고 함.  

##### 단점
- 사용자가 많이 접속 시 메모리 부족 혹은 하드디스크용량 부족.    
- 메모리에 저장한 경우 서버에 문제가 발생하여 전원을 끈다면, 저장된 세션 정보는 모두 삭제된다.    
사용자들은 다시 로그인해야한다.    
(참고: 하드디스크에 저장하면 메모리에 저장할 때 보다 느리다)   
- 여러 서버가 존재하는 경우 각자의 메모리, 하드디스크에 저장해 두는 데,     
사용자의 요청을 로드밸런싱을 통하여 분산 운영을 한다.   
이 때, 로그인 한 서버, 요청한 서버가 다를 경우, 세션 유지가 되지 않는 상황이 발생한다.  
(참고: 데이터베이스에 넣어두거나 Redis나 M,emCached같은 메모리형 데이터베이스 서버를 두어 그 곳에 저장하기도 함)   
*서버가 복잡한 구성과 환경에서 어떤 상태를 기억해야된다는 것이 부담이 된다*   

### JWT(Json web Token)
세션의 단점으로 인증을 간단하게 하기 위한 방법으로 등장된 것이 토큰 방식인 JWT 이다.   
사용자가 로그인 하면, XX랜드 표를 반쪽 찢지 않고 그냥 준다(토큰을 준다).    
즉, 서버는 토큰을 발급하고 기억하고 있지 않는다(stateless).   

##### 구성
인코딩 또는 암호화된 3가지 데이터를 이어붙인 방식  
header.pay load.verify signature   
[헤더.페이로드.서명]  

###### 페이로드  
Base64로 디코딩하면 json형식의 정보가 담겨있음  
Claim(==토큰에 담긴 정보): 누가 누구에게 발급했는 지, 유효기간, 사용자 닉네임, 서비스상 레벨, 관리자 여부 등  

###### 헤더
token type, alg  
[토큰타입(jwt고정), 암호화 알고리즘(지정가능)]  

###### 서명
페이로드 + 헤더 + 서버에 숨긴 값 ==> 서명 값이 나옴    
  
서버는 요청이 오면, 헤더와 페이로드 그리고 숨긴 값을 통하여     
계산된 값이 요청된 서명과 동일한 지 확인한다.    

###### 단점
- 세션은 상태를 저장하고 있기 때문에 원할 때 언제든 제어할 수 있게되는 데, jwt는 불가능하다. 
제어를 위해 상태를 저장하면 세션이랑 같아저 의미가 없어진다.  
- 위와 같은 맥락에서, 토큰을 탈취당한 경우, 토큰을 무효화할 방법이 없다.  

###### 단점 보완 방법
로그인 시, 토큰 2개 발급.  
하나는 access토큰: 토큰의 만료시간을 짧게 설정, 요청할 때 실어보내는 용도  
다른 하나는 refresh토큰 : access 토큰이 만료되었을 때 재발급 해주는 용도. 데이터베이스에 저장  
 
access 토큰이 수명을 다하면 refresh토큰을 서버로 보내어     
서버는 데이터베이스에 저장된 값과 대조해보고다면    
맞다면 access 토큰을 재발급해준다.   
이렇게 하면, access 토큰이 만료되어도 로그인은 해제되지 않고,     
access 토큰이 탈취당한 경우에는 데이터베이스에 저장된 refresh 토큰 정보를 지워   
탈취에 대한 취약점을 조금 보완할 수 있다.   
(그러나 역시 탈취 당한 즉시 토큰을 만료시켜버릴 수가 없다.)   




[참고 자료]  
https://www.youtube.com/watch?v=1QiOXWEbqYQ
